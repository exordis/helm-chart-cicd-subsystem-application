# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Entities/Secrets
templates:
  - templates/secrets.yaml
values:
  - ../values.metadata.yaml
tests:
  - it: Should generate secret from minimum data in values 
    template: templates/secrets.yaml
    set:
      secrets:
        password:
          stringData:
            key: "value" 
    documentSelector:
      path: metadata.name
      value: some-subsystem-some-application-password 
    asserts:
      - equal:
          path: stringData.key
          value: value
      - equal:
          path: metadata.namespace
          value: some-subsystem-test


  - it: Should generate secret with provided namespace 
    template: templates/secrets.yaml
    set:
      secrets:
        password:
          namespace: some-namespace
          stringData:
            key: "value" 
    documentSelector:
      path: metadata.name
      value: some-subsystem-some-application-password
    asserts:
      - equal:
          path: metadata.namespace
          value: some-namespace


  - it: Should generate secret from empty stringData
    template: templates/secrets.yaml
    set:
      secrets:
        password:
          namespace: mynamespace
    documentSelector:
      path: metadata.name
      value: some-subsystem-some-application-password 
    asserts:
      - lengthEqual:
          path: stringData
          count: 0


  - it: Should generate secret from empty definition
    template: templates/secrets.yaml
    set:
      secrets:
        password: 
    documentSelector:
      path: metadata.name
      value: some-subsystem-some-application-password 
    asserts:
      - lengthEqual:
          path: stringData
          count: 0
          
  - it: Should fail when referencing non existing container
    template: templates/secrets.yaml
    set:
      secrets:
        password:
          containers: 
            - missing
          stringData:
            key: "value" 
    asserts:
      - failedTemplate:
          errorPattern: "Secret 'password' references undefined containers: 'missing'"